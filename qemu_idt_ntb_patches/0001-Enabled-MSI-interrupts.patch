From 1af480090d0ff032fdd520232b3937e52158e60b Mon Sep 17 00:00:00 2001
From: name <you@example.com>
Date: Mon, 3 Jul 2023 16:50:46 +0000
Subject: [PATCH] Enabled MSI interrupts

---
 hw/misc/ivshmem.c | 15 ++++++++++-----
 1 file changed, 10 insertions(+), 5 deletions(-)

diff --git a/hw/misc/ivshmem.c b/hw/misc/ivshmem.c
index e1b8b6f7b5..eec1f0b70d 100644
--- a/hw/misc/ivshmem.c
+++ b/hw/misc/ivshmem.c
@@ -870,9 +870,9 @@ static void ivshmem_common_realize(PCIDevice *dev, Error **errp)
 
     pci_conf = dev->config;
     pci_conf[PCI_COMMAND] = PCI_COMMAND_IO | PCI_COMMAND_MEMORY;
-    IVSHMEM_DPRINTF("Setting value for config\n");
-	pci_set_long(&pci_conf[0x1C], 0xc00U); 
-	pci_set_long(&pci_conf[0x470], 0xc00U); 
+    //IVSHMEM_DPRINTF("Setting value for config\n");
+	//pci_set_long(&pci_conf[0x1C], 0xc00U); 
+	//pci_set_long(&pci_conf[0x470], 0xc00U); 
 
     memory_region_init_io(&s->ivshmem_mmio, OBJECT(s), &ivshmem_mmio_ops, s,
                           "ivshmem-mmio", IVSHMEM_REG_BAR_SIZE);
@@ -920,6 +920,10 @@ static void ivshmem_common_realize(PCIDevice *dev, Error **errp)
             error_prepend(errp, "Failed to initialize interrupts: ");
             return;
         }
+        if (msi_init(dev, 0, 1, false, false, errp)) {
+            error_prepend(errp, "Failed to initialize MSI interrupts: ");
+            return;
+        }
     }
 
     if (s->master == ON_OFF_AUTO_AUTO) {
@@ -936,11 +940,11 @@ static void ivshmem_common_realize(PCIDevice *dev, Error **errp)
     }
 
     vmstate_register_ram(s->ivshmem_bar2, DEVICE(s));
-    /*pci_register_bar(PCI_DEVICE(s), 2,
+    pci_register_bar(PCI_DEVICE(s), 2,
                      PCI_BASE_ADDRESS_SPACE_MEMORY |
                      PCI_BASE_ADDRESS_MEM_PREFETCH |
                      PCI_BASE_ADDRESS_MEM_TYPE_64,
-                     s->ivshmem_bar2);*/
+                     s->ivshmem_bar2);
 }
 
 static void ivshmem_exit(PCIDevice *dev)
@@ -1125,6 +1129,7 @@ static void ivshmem_doorbell_init(Object *obj)
 
     s->features |= (1 << IVSHMEM_MSI);
     PCI_DEVICE(obj)->cap_present |= QEMU_PCI_CAP_EXPRESS;
+	IVSHMEM_DPRINTF("Device has msi interrupts is %d\n", PCI_DEVICE(obj)->cap_present & QEMU_PCI_CAP_MSI);
 }
 
 static void ivshmem_doorbell_realize(PCIDevice *dev, Error **errp)
-- 
2.30.2

